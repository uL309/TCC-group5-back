# Docker Compose for TrueNAS Scale Deployment
# Optimized for TrueNAS Scale Apps and persistent storage

version: '3.8'

services:
  # MySQL Database with persistent storage
  mysql-db:
    image: mysql:8.0
    container_name: airtrack-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-airtrack_db}
      MYSQL_USER: ${MYSQL_USER:-airtrack}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-airtrackpass}
    ports:
      - "3306:3306"
    volumes:
      # TrueNAS persistent storage path
      - /mnt/tank/apps/airtrack/mysql-data:/var/lib/mysql
      - /mnt/tank/apps/airtrack/mysql-init/dump.sql:/docker-entrypoint-initdb.d/dump.sql:ro
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - airtrack-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # RabbitMQ Message Queue
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: airtrack-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
    volumes:
      # TrueNAS persistent storage
      - /mnt/tank/apps/airtrack/rabbitmq-data:/var/lib/rabbitmq
    networks:
      - airtrack-net
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3

  # Java Spring Boot Backend
  backend:
    image: airtrack/backend:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: airtrack-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-truenas}
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-db:3306/${MYSQL_DATABASE:-airtrack_db}?maxAllowedPacket=67108864&serverTimezone=America/Sao_Paulo
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER:-airtrack}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD:-airtrackpass}
      JWT_SECRET: ${JWT_SECRET:-airtrackverysecret}
      SPRING_MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      SPRING_MAIL_USERNAME: ${MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      AZURE_STORAGE_ACCOUNT_NAME: ${AZURE_STORAGE_ACCOUNT_NAME}
      AZURE_STORAGE_ACCOUNT_KEY: ${AZURE_STORAGE_ACCOUNT_KEY}
      JAVA_OPTS: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=80.0 -XX:+UseG1GC"
      # TrueNAS specific
      SERVER_ADDRESS: 0.0.0.0
      TRUENAS_HOST: ${TRUENAS_HOST:-truenas.local}
    volumes:
      # Application logs persistent storage
      - /mnt/tank/apps/airtrack/backend-logs:/app/logs
      # Upload/file storage
      - /mnt/tank/apps/airtrack/uploads:/app/uploads
    depends_on:
      mysql-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - airtrack-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Report Server Microservice
  report-server:
    image: airtrack/reportserver:latest
    build:
      context: ./ReportServer
      dockerfile: Dockerfile
    container_name: airtrack-reports
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      BACKEND_URL: http://backend:8080
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      # TrueNAS specific
      TRUENAS_HOST: ${TRUENAS_HOST:-truenas.local}
    volumes:
      # Report generation temp files
      - /mnt/tank/apps/airtrack/reports-temp:/app/temp
      # Generated reports storage
      - /mnt/tank/apps/airtrack/reports-output:/app/reports
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - airtrack-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Angular Frontend
  frontend:
    image: airtrack/frontend:latest
    build:
      context: ../air-track-front
      dockerfile: Dockerfile
    container_name: airtrack-frontend
    restart: unless-stopped
    ports:
      - "4200:4200"
    environment:
      API_URL: http://${TRUENAS_HOST:-truenas.local}:8080
      REPORT_SERVER_URL: http://${TRUENAS_HOST:-truenas.local}:3000
      TRUENAS_HOST: ${TRUENAS_HOST:-truenas.local}
    volumes:
      # Nginx logs
      - /mnt/tank/apps/airtrack/nginx-logs:/var/log/nginx
    depends_on:
      backend:
        condition: service_healthy
      report-server:
        condition: service_healthy
    networks:
      - airtrack-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4200/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Backup service for TrueNAS
  backup:
    image: alpine:latest
    container_name: airtrack-backup
    restart: "no"  # Run on-demand
    environment:
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
    volumes:
      - /mnt/tank/apps/airtrack:/data
      - /mnt/tank/backups/airtrack:/backup
    command: |
      sh -c "
        echo 'Creating backup...'
        DATE=\$$(date +%Y%m%d_%H%M%S)
        tar -czf /backup/airtrack_backup_\$$DATE.tar.gz -C /data .
        echo 'Backup created: airtrack_backup_\$$DATE.tar.gz'
        
        # Clean old backups
        find /backup -name 'airtrack_backup_*.tar.gz' -type f -mtime +\$$BACKUP_RETENTION_DAYS -delete
        echo 'Old backups cleaned up'
      "
    networks:
      - airtrack-net
    profiles:
      - backup

volumes:
  # Named volumes for easier management in TrueNAS
  mysql-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/tank/apps/airtrack/mysql-data

  rabbitmq-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/tank/apps/airtrack/rabbitmq-data

networks:
  airtrack-net:
    driver: bridge
    name: airtrack-network
    ipam:
      config:
        - subnet: 172.20.0.0/16